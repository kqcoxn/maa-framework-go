# 按键操作配置

<cite>
**本文档引用文件**  
- [pipeline.go](file://pipeline.go)
- [controller.go](file://controller.go)
- [custom_controller.go](file://custom_controller.go)
- [controller/adb/adb.go](file://controller/adb/adb.go)
- [controller/win32/win32.go](file://controller/win32/win32.go)
- [context_test.go](file://context_test.go)
- [internal/native/framework.go](file://internal/native/framework.go)
</cite>

## 目录
1. [简介](#简介)
2. [NodeActionTypePressKey 实现机制](#nodeactiontypepresskey-实现机制)
3. [ActPressKey 构造函数参数配置](#actpresskey-构造函数参数配置)
4. [Key 参数取值范围与平台差异](#key-参数取值范围与平台差异)
5. [长按操作持续时间 Duration 配置](#长按操作持续时间-duration-配置)
6. [不同设备类型对按键操作的支持](#不同设备类型对按键操作的支持)
7. [系统按键与特殊功能键配置示例](#系统按键与特殊功能键配置示例)
8. [PreDelay/PostDelay 参数协调作用](#predelaypostdelay-参数协调作用)
9. [总结](#总结)

## 简介
本文档深入解析 `NodeAction` 结构体中按键操作（`NodeActionTypePressKey`）的实现机制，重点说明 `ActPressKey` 构造函数的参数配置。详细分析 `Key` 参数的取值范围和平台差异，包括 Android 键值和 Windows 虚拟键码的映射关系。解释长按操作的持续时间（`Duration`）参数配置方法，以及不同设备类型对按键操作的支持程度。结合代码示例展示如何配置系统按键（如返回、Home）和特殊功能键的操作，并说明 `PreDelay`/`PostDelay` 参数在按键操作序列中的协调作用。

## NodeActionTypePressKey 实现机制
`NodeActionTypePressKey` 是用于表示按键操作的节点动作类型，其核心实现依赖于 `NodeLongPressKeyParam` 结构体。该结构体定义了按键操作所需的关键参数，包括虚拟键码（`Key`）和长按持续时间（`Duration`）。通过 `ActLongPressKey` 函数创建 `NodeAction` 实例，将按键操作封装为可执行的任务节点。

**Section sources**
- [pipeline.go](file://pipeline.go#L1794-L1819)

## ActPressKey 构造函数参数配置
`ActLongPressKey` 函数是创建长按按键操作的核心构造函数，接受虚拟键码数组和可选的配置选项。其函数签名如下：
```go
func ActLongPressKey(key []int, opts ...LongPressKeyOption) *NodeAction
```
其中，`key` 参数为必需项，表示要按下的虚拟键码；`opts` 为可变参数，允许通过函数式选项模式配置额外行为，如设置长按持续时间。

**Section sources**
- [pipeline.go](file://pipeline.go#L1812-L1819)

## Key 参数取值范围与平台差异
`Key` 参数用于指定虚拟键码，其取值范围因平台而异：

- **Android 平台**：使用 Android 系统定义的键值（KeyEvent codes），例如 `KEYCODE_BACK`（返回键，值为 4）、`KEYCODE_HOME`（Home 键，值为 3）等。
- **Windows 平台**：使用 Windows 虚拟键码（Virtual-Key Codes），例如 `VK_RETURN`（回车键，值为 0x0D）、`VK_ESCAPE`（退出键，值为 0x1B）等。

在 ADB 控制器中，键码通过 `MaaControllerPostClickKey` 原生接口传递；在 Win32 控制器中，则通过 `MaaWin32ControllerCreate` 创建的控制器实例处理。

**Section sources**
- [pipeline.go](file://pipeline.go#L1796-L1797)
- [controller/adb/adb.go](file://controller/adb/adb.go#L22-L44)
- [controller/win32/win32.go](file://controller/win32/win32.go#L19-L38)
- [internal/native/framework.go](file://internal/native/framework.go#L169)

## 长按操作持续时间 Duration 配置
`Duration` 参数用于定义长按操作的持续时间，单位为毫秒，默认值为 1000 毫秒。可通过 `WithLongPressKeyDuration` 函数式选项进行配置，该函数接受 `time.Duration` 类型参数并自动转换为毫秒值。

示例配置：
```go
ActLongPressKey([]int{4}, WithLongPressKeyDuration(2*time.Second))
```
此配置将执行键码为 4 的按键长按操作，持续时间为 2 秒。

**Section sources**
- [pipeline.go](file://pipeline.go#L1798-L1810)

## 不同设备类型对按键操作的支持
不同设备类型通过各自的控制器实现对按键操作的支持：

- **ADB 控制器**：适用于 Android 设备，支持通过 ADB Shell、Minitouch、Maatouch 等多种输入方法执行按键操作。
- **Win32 控制器**：适用于 Windows 应用程序，支持通过 `SendMessage`、`PostMessage`、`Seize` 等输入方法模拟键盘事件。

控制器的输入方法在创建时通过 `inputMethod` 参数指定，框架会根据优先级自动选择可用的方法。

**Section sources**
- [controller.go](file://controller.go#L28-L76)
- [controller/adb/adb.go](file://controller/adb/adb.go#L15-L44)
- [controller/win32/win32.go](file://controller/win32/win32.go#L14-L38)

## 系统按键与特殊功能键配置示例
以下示例展示如何配置常见的系统按键操作：

### 返回键操作（Android）
```go
ActLongPressKey([]int{4})
```

### Home 键操作（Android）
```go
ActLongPressKey([]int{3})
```

### 回车键操作（Windows）
```go
ActLongPressKey([]int{0x0D})
```

### 组合键操作
支持同时按下多个键，例如：
```go
ActLongPressKey([]int{0x10, 0x41}) // Shift + A
```

**Section sources**
- [pipeline.go](file://pipeline.go#L1812-L1819)
- [context_test.go](file://context_test.go#L874-L897)

## PreDelay/PostDelay 参数协调作用
虽然 `NodeLongPressKeyParam` 本身未直接包含 `PreDelay` 和 `PostDelay` 参数，但在实际操作序列中，这些延迟参数通常由上层任务调度逻辑或自定义控制器通过 `CustomController` 接口的 `ClickKey` 方法间接实现。它们的作用如下：

- **PreDelay**：在执行按键操作前插入延迟，确保前序操作完全完成。
- **PostDelay**：在按键操作结束后插入延迟，等待系统响应或动画结束。

这种机制有助于提高自动化操作的稳定性和可靠性，特别是在处理复杂 UI 交互时。

**Section sources**
- [custom_controller.go](file://custom_controller.go#L60)
- [pipeline.go](file://pipeline.go#L1794-L1819)

## 总结
本文档全面解析了 `NodeActionTypePressKey` 的实现机制，涵盖了 `ActPressKey` 构造函数的参数配置、`Key` 参数的平台差异、`Duration` 参数的配置方法，以及不同设备类型对按键操作的支持情况。通过具体示例展示了系统按键和特殊功能键的配置方式，并解释了 `PreDelay`/`PostDelay` 参数在操作序列中的协调作用。这些内容为开发者提供了清晰的指导，以便在不同平台上高效地实现按键自动化操作。