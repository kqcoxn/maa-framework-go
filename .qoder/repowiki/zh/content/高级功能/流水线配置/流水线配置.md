# 流水线配置

<cite>
**本文档引用文件**   
- [pipeline.go](file://pipeline.go)
- [examples/quick-start/resource/pipeline/pipeline.json](file://examples/quick-start/resource/pipeline/pipeline.json)
- [examples/custom-action/resource/pipeline/pipeline.json](file://examples/custom-action/resource/pipeline/pipeline.json)
- [examples/custom-recognition/resource/pipeline/pipeline.json](file://examples/custom-recognition/resource/pipeline/pipeline.json)
- [context.go](file://context.go)
</cite>

## 目录
1. [Node结构体详解](#node结构体详解)
2. [识别配置（Recognition）](#识别配置recognition)
3. [动作配置（Action）](#动作配置action)
4. [流程控制](#流程控制)
5. [错误处理与超时](#错误处理与超时)
6. [自定义识别与动作](#自定义识别与动作)
7. [Go API动态构建](#go-api动态构建)
8. [实例分析](#实例分析)

## Node结构体详解

`Node`结构体是流水线配置的核心，定义了任务流中的单个节点。每个节点包含一系列字段，用于控制其行为和与其他节点的交互。

- **Name**: 节点的名称，作为其在流水线中的唯一标识符。
- **Anchor**: 锚点列表，可通过`[Anchor]`属性在`next`或`on_error`列表中引用。
- **Recognition**: 定义节点如何在屏幕上识别目标。
- **Action**: 定义当识别成功时执行的动作。
- **Next**: 指定可能执行的下一个节点列表。
- **RateLimit**: 设置识别尝试之间的最小时间间隔（毫秒），默认为1000。
- **Timeout**: 设置等待识别的最大时间（毫秒），默认为20000。
- **OnError**: 指定当识别超时或动作执行失败时执行的节点。
- **Inverse**: 反转识别结果，即识别失败时视为成功。
- **Enabled**: 确定节点是否处于活动状态，默认为true。
- **MaxHit**: 设置节点的最大命中次数，达到后不再执行。
- **PreDelay**: 在动作执行前的延迟时间（毫秒），默认为200。
- **PostDelay**: 在动作执行后的延迟时间（毫秒），默认为200。
- **PreWaitFreezes**: 在动作执行前等待屏幕稳定。
- **PostWaitFreezes**: 在动作执行后等待屏幕稳定。
- **Focus**: 指定自定义焦点数据。
- **Attach**: 为节点提供附加的自定义数据。

**Section sources**
- [pipeline.go](file://pipeline.go#L37-L72)

## 识别配置（Recognition）

`NodeRecognition`结构体定义了节点的识别配置，支持多种识别算法类型。

### 识别类型

- **DirectHit**: 不进行实际识别，总是成功。
- **TemplateMatch**: 模板匹配，通过图像模板进行识别。
- **FeatureMatch**: 特征匹配，提供更好的透视和尺度不变性。
- **ColorMatch**: 颜色匹配，基于颜色空间进行识别。
- **OCR**: 光学字符识别，用于识别文本。
- **NeuralNetworkClassify**: 神经网络分类，对固定位置的图像进行分类。
- **NeuralNetworkDetect**: 神经网络检测，检测任意位置的对象。
- **Custom**: 自定义识别，使用用户注册的识别器。

### 模板匹配参数（NodeTemplateMatchParam）

- **ROI**: 识别的感兴趣区域。
- **ROIOffset**: 应用于ROI的偏移。
- **Template**: 模板图像的路径列表。
- **Threshold**: 匹配阈值[0-1.0]，默认为0.7。
- **OrderBy**: 结果排序方式，默认为Horizontal。
- **Index**: 从结果中选择的匹配项。
- **Method**: 匹配算法，1: SQDIFF_NORMED, 3: CCORR_NORMED, 5: CCOEFF_NORMED，默认为5。
- **GreenMask**: 启用绿色掩码以处理透明区域。

### OCR参数（NodeOCRParam）

- **ROI**: 识别的感兴趣区域。
- **ROIOffset**: 应用于ROI的偏移。
- **Expected**: 期望的文本结果，支持正则表达式。
- **Threshold**: 模型置信度阈值[0-1.0]，默认为0.3。
- **Replace**: 文本替换规则，用于纠正OCR错误。
- **OrderBy**: 结果排序方式，默认为Horizontal。
- **Index**: 从结果中选择的匹配项。
- **OnlyRec**: 启用仅识别模式，无需检测（需要精确的ROI）。
- **Model**: 模型文件夹路径。

**Section sources**
- [pipeline.go](file://pipeline.go#L438-L977)

## 动作配置（Action）

`NodeAction`结构体定义了节点的动作配置，支持多种动作类型。

### 动作类型

- **DoNothing**: 不执行任何操作。
- **Click**: 点击指定位置。
- **LongPress**: 长按指定位置。
- **Swipe**: 滑动操作。
- **MultiSwipe**: 多指滑动。
- **TouchDown**: 触摸按下。
- **TouchMove**: 触摸移动。
- **TouchUp**: 触摸释放。
- **ClickKey**: 点击虚拟键。
- **LongPressKey**: 长按虚拟键。
- **KeyDown**: 按下虚拟键。
- **KeyUp**: 释放虚拟键。
- **InputText**: 输入文本。
- **StartApp**: 启动应用。
- **StopApp**: 停止应用。
- **StopTask**: 停止当前任务链。
- **Scroll**: 滚动操作。
- **Command**: 执行命令。
- **Custom**: 自定义动作。

### 点击参数（NodeClickParam）

- **Target**: 点击目标位置。
- **TargetOffset**: 应用于目标的偏移。
- **Contact**: 触摸点标识符。

### 滑动参数（NodeSwipeParam）

- **Begin**: 滑动起始位置。
- **BeginOffset**: 应用于起始位置的偏移。
- **End**: 滑动结束位置。
- **EndOffset**: 应用于结束位置的偏移。
- **Duration**: 滑动持续时间（毫秒），默认为200。
- **EndHold**: 在结束位置额外等待的时间（毫秒），默认为0。
- **OnlyHover**: 启用悬停模式，无需按下/释放操作。
- **Contact**: 触摸点标识符。

**Section sources**
- [pipeline.go](file://pipeline.go#L1204-L1517)

## 流程控制

`Next`字段定义了节点执行成功后的下一个节点列表。`NodeNextItem`结构体包含以下字段：

- **Name**: 目标节点的名称。
- **JumpBack**: 指示在此节点链完成后是否跳回父节点。
- **Anchor**: 指示此节点是否应设置为锚点。

`JumpBack`机制允许在完成一个节点链后返回到父节点，并从`next`列表的开头继续识别。这可以用于实现循环。

**Section sources**
- [pipeline.go](file://pipeline.go#L300-L380)

## 错误处理与超时

`OnError`字段定义了当识别超时或动作执行失败时执行的节点列表。`Timeout`字段设置等待识别的最大时间（毫秒），默认为20000。`RateLimit`字段设置识别尝试之间的最小时间间隔（毫秒），默认为1000。

**Section sources**
- [pipeline.go](file://pipeline.go#L49-L54)

## 自定义识别与动作

`Custom`类型允许用户注册自定义的识别器和动作。`NodeCustomRecognitionParam`和`NodeCustomActionParam`结构体分别定义了自定义识别和动作的参数。

- **CustomRecognition**: 注册的识别器名称。
- **CustomRecognitionParam**: 传递给识别回调的自定义参数。
- **CustomAction**: 注册的动作名称。
- **CustomActionParam**: 传递给动作回调的自定义参数。

**Section sources**
- [pipeline.go](file://pipeline.go#L1152-L1199)
- [pipeline.go](file://pipeline.go#L1984-L1999)

## Go API动态构建

`NewPipeline`函数创建一个新的空流水线。`NewNode`函数创建一个具有给定名称和选项的新节点。`With*`系列函数提供了功能选项，用于配置节点的各个字段。

```go
pipeline := NewPipeline()
node := NewNode("Startup", WithAction(ActStartApp("com.example.app")))
pipeline.AddNode(node)
```

**Section sources**
- [pipeline.go](file://pipeline.go#L18-L34)
- [pipeline.go](file://pipeline.go#L187-L197)

## 实例分析

### 快速启动实例

```json
{
    "Startup": {
        "action": "StartApp"
    }
}
```

此实例定义了一个名为"Startup"的节点，其动作为"StartApp"，用于启动应用。

### 自定义动作实例

```json
{
    "Startup": {
        "action": "Custom",
        "custom_action": "MyAct"
    }
}
```

此实例定义了一个名为"Startup"的节点，其动作为"Custom"，并指定了自定义动作"MyAct"。

### 自定义识别实例

```json
{
    "Startup": {
        "recognition": "Custom",
        "custom_recognition": "MyRec"
    },
    "TaskA": {
        "doc": "do something"
    },
    "TaskB": {
        "doc": "do something"
    }
}
```

此实例定义了一个名为"Startup"的节点，其识别为"Custom"，并指定了自定义识别器"MyRec"。同时定义了"TaskA"和"TaskB"两个节点。

**Section sources**
- [examples/quick-start/resource/pipeline/pipeline.json](file://examples/quick-start/resource/pipeline/pipeline.json)
- [examples/custom-action/resource/pipeline/pipeline.json](file://examples/custom-action/resource/pipeline/pipeline.json)
- [examples/custom-recognition/resource/pipeline/pipeline.json](file://examples/custom-recognition/resource/pipeline/pipeline.json)