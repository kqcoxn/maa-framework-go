# 基于节点的流水线系统

<cite>
**本文档中引用的文件**   
- [node.go](file://node.go)
- [pipeline.go](file://pipeline.go)
- [job.go](file://job.go)
- [context.go](file://context.go)
- [tasker.go](file://tasker.go)
- [controller.go](file://controller.go)
- [resource.go](file://resource.go)
- [custom_action.go](file://custom_action.go)
- [custom_recognition.go](file://custom_recognition.go)
- [examples/quick-start/main.go](file://examples/quick-start/main.go)
- [examples/custom-action/main.go](file://examples/custom-action/main.go)
- [examples/custom-recognition/main.go](file://examples/custom-recognition/main.go)
- [examples/quick-start/resource/pipeline/pipeline.json](file://examples/quick-start/resource/pipeline/pipeline.json)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
该文档详细介绍了基于节点的流水线系统，这是一个用于自动化测试的跨平台框架，基于图像识别技术。系统采用声明式任务流与JSON配置相结合的方式，支持自定义识别算法和动作逻辑。通过Go语言绑定，实现了对MaaFramework的高效调用，无需CGO即可运行。

## 项目结构
该项目采用模块化设计，主要分为控制器、示例、内部组件、测试和核心功能模块。核心功能包括节点管理、流水线处理、任务调度、资源管理和自定义动作/识别等。示例代码展示了快速启动、自定义动作和识别的实现方式。

```mermaid
graph TD
subgraph "核心模块"
A[node.go] --> B[pipeline.go]
B --> C[job.go]
C --> D[context.go]
D --> E[tasker.go]
end
subgraph "资源与控制"
F[controller.go] --> G[resource.go]
end
subgraph "自定义扩展"
H[custom_action.go] --> I[custom_recognition.go]
end
subgraph "示例应用"
J[examples/quick-start] --> K[examples/custom-action]
K --> L[examples/custom-recognition]
end
A --> F
B --> G
E --> F
E --> G
```

**Diagram sources**
- [node.go](file://node.go#L1-L2245)
- [pipeline.go](file://pipeline.go#L1-L42)
- [job.go](file://job.go#L1-L96)
- [context.go](file://context.go#L1-L249)
- [tasker.go](file://tasker.go#L1-L590)
- [controller.go](file://controller.go#L1-L359)
- [resource.go](file://resource.go#L1-L425)

**Section sources**
- [node.go](file://node.go#L1-L2245)
- [pipeline.go](file://pipeline.go#L1-L42)
- [job.go](file://job.go#L1-L96)
- [context.go](file://context.go#L1-L249)
- [tasker.go](file://tasker.go#L1-L590)
- [controller.go](file://controller.go#L1-L359)
- [resource.go](file://resource.go#L1-L425)
- [custom_action.go](file://custom_action.go#L1-L97)
- [custom_recognition.go](file://custom_recognition.go#L1-L108)

## 核心组件

系统的核心组件包括节点（Node）、流水线（Pipeline）、任务器（Tasker）、上下文（Context）、控制器（Controller）和资源（Resource）。这些组件协同工作，实现了自动化任务的定义、调度和执行。

**Section sources**
- [node.go](file://node.go#L1-L2245)
- [pipeline.go](file://pipeline.go#L1-L42)
- [tasker.go](file://tasker.go#L1-L590)
- [context.go](file://context.go#L1-L249)

## 架构概述

该系统采用分层架构设计，从底层的控制器到上层的任务调度，形成了完整的自动化测试解决方案。任务器作为核心协调者，连接控制器和资源，管理任务的生命周期。

```mermaid
graph TB
subgraph "用户层"
A[应用程序]
end
subgraph "框架层"
B[Tasker]
C[Context]
D[Pipeline]
E[Node]
end
subgraph "资源层"
F[Resource]
G[Controller]
end
A --> B
B --> C
C --> D
D --> E
B --> F
B --> G
F --> H[(资源文件)]
G --> I[(目标设备)]
```

**Diagram sources**
- [tasker.go](file://tasker.go#L1-L590)
- [context.go](file://context.go#L1-L249)
- [pipeline.go](file://pipeline.go#L1-L42)
- [node.go](file://node.go#L1-L2245)
- [resource.go](file://resource.go#L1-L425)
- [controller.go](file://controller.go#L1-L359)

## 详细组件分析

### 节点组件分析
节点是流水线中的基本执行单元，包含识别、动作、跳转逻辑等配置。每个节点可以定义识别方式、执行动作、成功后的下一个节点以及错误处理机制。

```mermaid
classDiagram
class Node {
+string Name
+[]string Anchor
+*NodeRecognition Recognition
+*NodeAction Action
+[]NodeNextItem Next
+*int64 RateLimit
+*int64 Timeout
+[]NodeNextItem OnError
+bool Inverse
+*bool Enabled
+*uint64 MaxHit
+*int64 PreDelay
+*int64 PostDelay
+*NodeWaitFreezes PreWaitFreezes
+*NodeWaitFreezes PostWaitFreezes
+*uint64 Repeat
+*int64 RepeatDelay
+*NodeWaitFreezes RepeatWaitFreezes
+any Focus
+map[string]any Attach
}
class NodeRecognition {
+NodeRecognitionType Type
+NodeRecognitionParam Param
}
class NodeAction {
+NodeActionType Type
+NodeActionParam Param
}
class NodeNextItem {
+string Name
+bool JumpBack
+bool Anchor
}
Node --> NodeRecognition : "包含"
Node --> NodeAction : "包含"
Node --> NodeNextItem : "包含多个"
```

**Diagram sources**
- [node.go](file://node.go#L11-L319)

### 流水线组件分析
流水线是节点的集合，定义了任务的完整流程。通过JSON序列化支持配置文件的加载和保存。

```mermaid
classDiagram
class Pipeline {
+map[string]*Node nodes
}
class Node {
+string Name
}
Pipeline --> Node : "包含多个"
```

**Diagram sources**
- [pipeline.go](file://pipeline.go#L21-L42)

### 任务器组件分析
任务器负责任务的调度和执行，提供异步作业管理、状态跟踪和事件回调等功能。

```mermaid
sequenceDiagram
participant Application
participant Tasker
participant Controller
participant Resource
Application->>Tasker : PostTask("Startup")
Tasker->>Controller : PostConnect()
Controller-->>Tasker : 连接成功
Tasker->>Resource : 加载资源
Resource-->>Tasker : 资源加载完成
Tasker->>Tasker : 执行任务流程
Tasker-->>Application : 返回任务详情
```

**Diagram sources**
- [tasker.go](file://tasker.go#L13-L164)

### 自定义动作分析
支持用户注册自定义动作，扩展框架功能。通过接口实现灵活的业务逻辑定制。

```mermaid
classDiagram
class CustomActionRunner {
+Run(ctx *Context, arg *CustomActionArg) bool
}
class CustomActionArg {
+*TaskDetail TaskDetail
+string CurrentTaskName
+string CustomActionName
+string CustomActionParam
+*RecognitionDetail RecognitionDetail
+Rect Box
}
class Context {
+RunTask(entry string, override ...any) *TaskDetail
+RunRecognition(entry string, img image.Image, override ...any) *RecognitionDetail
+RunAction(entry string, box Rect, recognitionDetail string, override ...any) *ActionDetail
}
CustomActionRunner --> CustomActionArg : "使用"
CustomActionRunner --> Context : "调用"
```

**Diagram sources**
- [custom_action.go](file://custom_action.go#L46-L53)
- [context.go](file://context.go#L44-L131)

### 自定义识别分析
支持用户注册自定义识别算法，提供图像处理和结果返回的接口。

```mermaid
classDiagram
class CustomRecognitionRunner {
+Run(ctx *Context, arg *CustomRecognitionArg) (*CustomRecognitionResult, bool)
}
class CustomRecognitionArg {
+*TaskDetail TaskDetail
+string CurrentTaskName
+string CustomRecognitionName
+string CustomRecognitionParam
+image.Image Img
+Rect Roi
}
class CustomRecognitionResult {
+Rect Box
+string Detail
}
class Context {
+RunTask(entry string, override ...any) *TaskDetail
+RunRecognition(entry string, img image.Image, override ...any) *RecognitionDetail
}
CustomRecognitionRunner --> CustomRecognitionArg : "使用"
CustomRecognitionRunner --> CustomRecognitionResult : "返回"
CustomRecognitionRunner --> Context : "调用"
```

**Diagram sources**
- [custom_recognition.go](file://custom_recognition.go#L52-L54)
- [context.go](file://context.go#L44-L87)

## 依赖分析

系统各组件之间存在明确的依赖关系，形成了稳定的调用链。任务器依赖于控制器和资源，节点和流水线构成任务的基本单元，自定义动作和识别扩展了框架的功能。

```mermaid
graph TD
A[Node] --> B[Pipeline]
B --> C[Tasker]
C --> D[Controller]
C --> E[Resource]
F[CustomAction] --> C
G[CustomRecognition] --> C
H[Context] --> C
I[Job] --> C
J[Status] --> I
```

**Diagram sources**
- [node.go](file://node.go#L1-L2245)
- [pipeline.go](file://pipeline.go#L1-L42)
- [tasker.go](file://tasker.go#L1-L590)
- [controller.go](file://controller.go#L1-L359)
- [resource.go](file://resource.go#L1-L425)
- [custom_action.go](file://custom_action.go#L1-L97)
- [custom_recognition.go](file://custom_recognition.go#L1-L108)
- [context.go](file://context.go#L1-L249)
- [job.go](file://job.go#L1-L96)

**Section sources**
- [node.go](file://node.go#L1-L2245)
- [pipeline.go](file://pipeline.go#L1-L42)
- [tasker.go](file://tasker.go#L1-L590)
- [controller.go](file://controller.go#L1-L359)
- [resource.go](file://resource.go#L1-L425)
- [custom_action.go](file://custom_action.go#L1-L97)
- [custom_recognition.go](file://custom_recognition.go#L1-L108)
- [context.go](file://context.go#L1-L249)
- [job.go](file://job.go#L1-L96)

## 性能考虑
系统在设计时考虑了性能优化，通过异步任务处理、资源缓存和高效的图像处理算法来保证运行效率。任务器的异步作业机制允许并发执行多个任务，提高整体处理速度。

## 故障排除指南
当遇到问题时，可以通过以下步骤进行排查：
1. 检查MaaFramework动态库是否正确配置
2. 验证控制器连接状态
3. 确认资源文件路径正确
4. 检查任务配置的JSON格式
5. 查看系统日志获取详细错误信息

**Section sources**
- [controller.go](file://controller.go#L283-L286)
- [resource.go](file://resource.go#L306-L309)
- [tasker.go](file://tasker.go#L60-L63)

## 结论
基于节点的流水线系统提供了一个强大而灵活的自动化测试框架。通过模块化设计和清晰的接口定义，使得系统易于扩展和维护。支持自定义动作和识别算法，满足了复杂场景下的自动化需求。